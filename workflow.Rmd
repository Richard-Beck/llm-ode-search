---
title: "workflow"
author: "RJB"
date: "2025-08-12"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir="~/projects/llm-ode-search/")
```
```{r}
source("R/llm-ode-search.R")
model <- "edelstein"
spec <- jsonlite::fromJSON(paste0("data/ground_truth_specs/",model,".json"), simplifyVector=FALSE)
df_sam <- simulate_from_spec(spec)
target_data_df <- df_sam %>%
  group_by(condition, time, variable, model) %>%
  summarise(value = mean(value), .groups = "drop")

llmSearch(target_data_df,"tests/edelstein_gpt-oss-120b",LLM_ID = "gpt-oss-120b")
```


```{r}
model <- "edelstein"

spec <- jsonlite::fromJSON(paste0("data/ground_truth_specs/",model,".json"), simplifyVector=FALSE)
df_sam <- simulate_from_spec(spec)
target_data_df <- df_sam %>%
    group_by(condition, time, variable, model) %>%
    summarise(value = mean(value), .groups = "drop")

spec_t <- make_spec_transparent(spec)
df <- simulate_from_spec(spec_t)
  
p <- ggplot(df,aes(x=time,y=value))+
    facet_grid(cols=vars(condition),rows = vars(variable),scales="free")+
    geom_line(aes(group=replicate,color=as.character(replicate)))+
    geom_point(data=target_data_df,color="red")+
    ggtitle(model)
print(p)

for(i in 0:5){
  spec <- jsonlite::fromJSON(paste0("tests/edelstein_gpt-oss-120b/llm_proposals/prop_",i,".json"), simplifyVector=FALSE)
df_tar <- read.csv("tests/edelstein_gpt-oss-120b/target_data.csv")
fitted <- jsonlite::fromJSON(paste0("tests/edelstein_gpt-oss-120b/summaries/summary_",i,".json"), simplifyVector=FALSE)
opt_pars <- unlist(fitted$optimization_summary$optimized_parameters)

spec <- modify_spec_parms(opt_pars,spec)

df_ini <- simulate_from_spec(make_spec_transparent(spec))
lut <- names(spec$observe)  
names(lut) <- unlist(spec$observe)
df_ini$variable[df_ini$variable%in%names(lut)] <- lut[df_ini$variable[df_ini$variable%in%names(lut)]]

tit <- paste0("iter: ",i," Err.: ",fitted$optimization_summary$final_objective_value)
p <- ggplot(df_ini,aes(x=time,y=value))+
  facet_grid(cols=vars(condition),rows = vars(variable),scales="free")+
  geom_line()+
  geom_point(data=df_tar,color="red")+
  ggtitle(tit)
print(p)
}


```

